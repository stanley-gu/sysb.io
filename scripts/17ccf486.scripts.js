"use strict";angular.module("sysbIoApp",["ui.bootstrap","ui.ace","stanleygu.cytoscapeweb","stanley-gu.angular-rickshaw"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/load",{templateUrl:"views/load.html",controller:"LoadCtrl"}).when("/version",{templateUrl:"views/version.html",controller:"VersionCtrl"}).when("/version/:githubUserName/:githubRepository/:githubModelName",{templateUrl:"views/version.html",controller:"VersionCtrl"}).when("/simulate",{templateUrl:"views/simulate.html",controller:"SimulateCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("sysbIoApp").controller("MainCtrl",["$scope","$window","Githublogin",function(a,b,c){c.getAccessToken()?(a.classGithubLoginButton="btn btn-success",a.loginMessage="Connected to GitHub!"):(a.classGithubLoginButton="btn btn-danger",a.loginMessage="Log in to GitHub"),a.loginToGithub=function(){c.getAccessToken()||(b.OAuth.initialize("EFBBdvbz8MYOYgVTBxOG2sg7JGM"),b.OAuth.popup("github",function(b,d){a.$apply(function(){c.setAccessToken(d.access_token),a.classGithubLoginButton="btn btn-success",a.loginMessage="Logged in to GitHub"})}))}}]),angular.module("sysbIoApp").controller("LoadCtrl",["$scope","$http","Githublogin","Sbmlmodel",function(a,b,c,d){a.accessToken=c.getAccessToken(),a.$watch("githubUserName",function(){console.log("Detected a change in User Name!");var c="https://api.github.com/users/"+a.githubUserName+"/repos";a.accessToken&&(c+="?access_token="+a.accessToken+"&per_page=100"),b.get(c).success(function(b){var c=[];b.forEach(function(a){c.push(a.name)}),a.githubRepositories=c})}),a.$watch("githubRepository",function(){console.log("Detected a change in GitHub Repository Name!");var c="https://api.github.com/repos/"+a.githubUserName+"/"+a.githubRepository+"/branches/master";a.accessToken&&(c+="?access_token="+a.accessToken),b.get(c).success(function(c){var d="https://api.github.com/repos/"+a.githubUserName+"/"+a.githubRepository+"/git/trees/"+c.commit.sha+"?recursive=1";a.accessToken&&(d+="&access_token="+a.accessToken),b.get(d).success(function(b){var c=[];b.tree.forEach(function(a){c.push(a.path)}),a.githubFiles=c})})}),a.loadFromGithub=function(){b.defaults.headers.common.Accept=b.defaults.headers.common.Accept+", application/vnd.github.VERSION.raw";var c="https://api.github.com/repos/"+a.githubUserName+"/"+a.githubRepository+"/commits?path="+a.githubModelName;a.accessToken&&(c+="&access_token="+a.accessToken),b.get(c).success(function(c){c.forEach(function(a){console.log(a.commit.message)}),a.commits=c,a.models=[],a.commits.forEach(function(c,e,f){var g="https://api.github.com/repos/"+a.githubUserName+"/"+a.githubRepository+"/contents/"+a.githubModelName;a.accessToken&&(g+="?access_token="+a.accessToken),b.get(g,{params:{ref:c.sha}}).success(function(b){console.log(e),console.log(c.commit.message),a.models[f.length-1-e]={name:c.commit.message,text:b,checked:!1},d.setRepo(a.models)})})})},a.addVersion=function(){a.models.push({name:a.commitMessage,text:a.editorText,checked:!1})}}]),angular.module("sysbIoApp").controller("VersionCtrl",["$scope","Sbmlmodel","$http","Sbmldiff",function(a,b,c,d){a.models=b.getRepo(),a.bivesUrl="https://node-bives-c9-stanley-gu.c9.io",a.loadVersion=function(c){b.setCurrentIndex(c),d.getDiff(b.getCurrentModel(),b.getCurrentModel(),"loadVersion",function(c){b.setCurrentGraphml(c.graphml),a.previewGraphml=b.getCurrentGraphml(),a.$apply()})},a.compareVersions=function(){var b=[],c=0;return a.models.forEach(function(a,d){a.checked&&(c+=1,b.push(d))}),c>2?(alert("Please check only 2 versions to compare."),void 0):(2===c&&d.getDiff(a.models[b[0]].text,a.models[b[1]].text,"compareVersions",function(b){a.modelDiff=b.diff,a.graphml=b.graphml,a.$apply()}),void 0)}}]),angular.module("sysbIoApp").controller("SimulateCtrl",["$scope","$window","Sbmlmodel","Sbmldiff","Simulator",function(a,b,c,d,e){a.currentModel=c.getCurrentModel(),a.simGraphml=c.getCurrentGraphml(),a.simStartTime=0,a.simEndTime=100,a.simNumSteps=100,a.params=[],a.$watch("simStartTime + simEndTime + simNumSteps",function(){e.socket.emit("run",{method:"simulateEx",params:[a.simStartTime,a.simEndTime,a.simNumSteps]})}),a.paramUpdate=function(b){console.log("parameter updated!"),e.socket.emit("run",{method:"setGlobalParameterByIndex",params:[b,a.params[b].value]}),e.socket.emit("run",{method:"simulateEx",params:[a.simStartTime,a.simEndTime,a.simNumSteps]})},e.socket.emit("run",{method:"loadSBML",params:[a.currentModel]}),e.socket.emit("run",{method:"getGlobalParameterIds",params:[],postProcess:"stringArrayToString",freeMem:"freeStringArray"}),e.socket.emit("run",{method:"getGlobalParameterValues",params:[],postProcess:"vectorToString",freeMem:"freeVector"}),e.socket.on("response",function(c){if(console.log(c),c.method.indexOf("simulate")>-1){var d,e,f,g,h,i,j;for(i=new b.Rickshaw.Color.Palette({scheme:"classic9"}),c=c.output,g=c[0],h=c[0].length-1,j=[],d=0;h>d;d+=1){for(f={},f.name=g[d+1],f.data=[],f.color=i.color(),e=1;e<c.length;e+=1)f.data.push({x:parseInt(c[e][0],10),y:parseInt(c[e][d+1],10)});j.push(f)}a.simData=j,a.$apply()}else c.method.indexOf("getGlobalParameterValues")>-1?(a.paramValues=c.output.split("	"),a.paramValues.pop(),a.paramValues.forEach(function(b,c){a.params[c]||a.params.push({}),a.params[c].value=parseFloat(b),a.$apply()})):c.method.indexOf("getGlobalParameterIds")>-1&&(a.paramIds=c.output.split(" "),a.paramIds.forEach(function(b,c){a.params[c]||a.params.push({}),a.params[c].id=b,a.params[c].value=null,a.$apply()}))})}]),angular.module("sysbIoApp").service("Githublogin",["$window",function(a){this.getAccessToken=function(){return a.localStorage.getItem("accessToken")?a.localStorage.getItem("accessToken"):null},this.setAccessToken=function(b){a.localStorage.setItem("accessToken",b)}}]),angular.module("sysbIoApp").service("Sbmlmodel",["$window",function(a){this.setRepo=function(b){a.localStorage.setItem("sbmlRepo",JSON.stringify(b))},this.getRepo=function(){return JSON.parse(a.localStorage.getItem("sbmlRepo"))},this.setCurrentIndex=function(b){a.localStorage.setItem("sbmlIndex",b)},this.getCurrentIndex=function(){return a.localStorage.getItem("sbmlIndex")},this.getCurrentModel=function(){var a=this.getCurrentIndex(),b=this.getRepo();return b[a].text},this.setTwoDiffIndices=function(b){2===b.length&&a.localStorage.setItem("sbmlDiffIndices",JSON.stringify(b))},this.getTwoDiffIndices=function(){return JSON.parse(a.localStorage.getItem("sbmlDiffIndices"))},this.setCurrentGraphml=function(b){a.localStorage.setItem("sbmlGraphml",b)},this.getCurrentGraphml=function(){return a.localStorage.getItem("sbmlGraphml")}}]),angular.module("sysbIoApp").service("Sbmldiff",["$http","$window",function(a,b){this.bivesUrl="http://sysb.io:8002",this.getDiff=function(a,c,d,e){var f=b.io.connect(this.bivesUrl);f.emit("getDiff",{first:a,second:c,id:d}),f.on("response",function(a){a.id===d&&e(a)})}}]),angular.module("sysbIoApp").service("Simulator",["$window",function(a){this.socket=a.io.connect("http://sysb.io:8003"),this.socket.on("connect",function(){console.log("connected to simulator")})}]);