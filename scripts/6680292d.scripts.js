"use strict";angular.module("sysbIoApp",["ngSanitize","ui.bootstrap","ui.ace","infinite-scroll","ngTouch","ui.layout","highcharts-ng","ngRoute","ui.jq","ui.keypress"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/gallery",{templateUrl:"views/gallery.html",controller:"GalleryCtrl"}).when("/load",{templateUrl:"views/loadModal.html",controller:"LoadCtrl"}).when("/version",{templateUrl:"views/version.html",controller:"VersionCtrl"}).when("/version/:githubUserName/:githubRepository/:githubModelName*",{templateUrl:"views/version.html",controller:"VersionCtrl"}).when("/simulate",{templateUrl:"views/simulate.html",controller:"SimulateCtrl"}).when("/simulate/:githubUserName/:githubRepository/:githubModelName*",{templateUrl:"views/simulate.html",controller:"SimulateCtrl"}).when("/modelLayout",{templateUrl:"views/modelLayout.html",controller:"ModelLayoutCtrl"}).otherwise({redirectTo:"/"})}]).config(["$compileProvider",function(a){a.imgSrcSanitizationWhitelist(/^\s*(https?|ftp|file|blob):|data:image\//),a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|tel|file|blob):/)}]),angular.module("sysbIoApp").controller("MainCtrl",["$scope","$window","App","$modal","Github","$routeParams","$route",function(a,b,c,d,e,f,g){if(a.App=c,a.$routeParams=f,a.$route=g,a.loginMessage=function(){return c.data.github.accessToken?"Logged in":"Log in"},a.loginToGithub=function(){c.data.github.accessToken||(b.OAuth.initialize("EFBBdvbz8MYOYgVTBxOG2sg7JGM"),b.OAuth.popup("github",function(b,d){a.$apply(function(){c.setAccessToken(d.access_token)})}))},a.logOutOfGithub=function(){c.removeAccessToken()},a.windowPaneSize="50-50",a.model=c.data.model,a.startModalLoadModel=function(){d.open({templateUrl:"views/loadModal.html",controller:"LoadModalCtrl"})},a.startSaveModal=function(){d.open({templateUrl:"views/saveModal.html",controller:"SaveModalCtrl"})},a.startModalVersion=function(){d.open({templateUrl:"views/versionModal.html",controller:"VersionCtrl"})},a.exportSbml=function(){d.open({templateUrl:"views/exportModal.html",controller:"ExportModalCtrl"})},a.newModel=function(){var a=d.open({templateUrl:"views/newModal.html"});a.result.then(function(a){c.newModel(a)})},a.terminalInitFun=function(b,c){if(""!==b)try{var d=a.$eval(b);void 0!==d&&c.echo(String(d))}catch(e){c.error(String(e))}else c.echo("")},a.terminalOptions={greetings:"Javascript Interpreter",name:"js_demo",height:200,prompt:"js> "},a.save=c.save,a.unsave=c.unsave,a.getModel=function(){c.rpc("getModel",{}),c.rpc("getCompartments",{}),c.rpc("getSpecies",{}),c.rpc("getReactions",{}),c.rpc("getModelName",{}),c.rpc("getModelId",{})},a.newReactants=[],a.newProducts=[],a.addReaction=function(){var b=[],d=[];a.newReactants.forEach(function(c,d){c&&b.push(a.model.species[d].id)}),a.newProducts.forEach(function(b,c){b&&d.push(a.model.species[c].id)}),c.rpc("addReaction",{id:a.newReactionId,name:a.newReactionName,reactants:b,products:d}),a.newReactants=[],a.newProducts=[]},a.$watch("App.cy.settings.zoomingEnabled",function(a){a&&c.cy.cy.zoomingEnabled(a)}),a.autoLayout=function(){c.cy.cy.autoLayout(c.cy.settings.autoLayout)},c.data.json.sbml){var h=c.x2js.json2xml_str(c.data.json);c.loadModel(h)}else e.setAccessToken(c.data.github.accessToken),e.getFile("stanley-gu","biomodels_db","curated/BIOMD0000000012.xml",function(a){c.loadModel(a)});b.App=c}]),angular.module("sysbIoApp").controller("LoadCtrl",["$scope","$http","GithubLogin","SbmlModel","Github",function(a,b,c,d,e){a.accessToken=c.getAccessToken(),a.github={},a.$watch("githubUserName",function(){console.log("Detected a change in User Name!"),e.getUserRepos(a.githubUserName,function(b){a.github.repos=b})}),a.$watch("githubRepository",function(){console.log("Detected a change in GitHub Repository Name!"),e.getRepoFiles(a.githubUserName,a.githubRepository,function(b){a.github.files=b})}),a.loadFromGithub=function(){e.getVersionHistory(a.githubUserName,a.githubRepository,a.githubModelName,function(b){a.models=b,d.setRepo(b)})},a.addVersion=function(){a.models.push({name:a.commitMessage,text:a.editorText,checked:!1})},a.loadFromText=function(){a.models=[],a.models.push({name:"SBML model",text:a.sbmlTextToLoad,checked:!1}),d.setRepo(a.models)},a.loadFromFile=function(){}}]),angular.module("sysbIoApp").controller("LoadModalCtrl",["$scope","App","$window","$modal","$modalInstance","$http",function(a,b,c,d,e,f){a.accessToken=b.accessToken;var g=b.github;a.github=b.data.github,a.$watch("github.user",function(){console.log("Detected a change in User Name!");var b=g.getUser(a.github.user);b.repos(function(b,c){a.github.repos=c})}),a.$watch("github.repo",function(){console.log("Detected a change in GitHub Repository Name!");var b=g.getRepo(a.github.user,a.github.repo);b.getTree("master?recursive=true",function(b,c){a.github.files=c})}),a.loadFromGithub=function(){var c=g.getRepo(a.github.user,a.github.repo);c.read("master",a.github.file,function(c,d){c?(a.loadingScreen.status="danger",a.loadingScreen.body="Sorry, could not load the model.",a.$apply()):(b.data.json.sbml=b.x2js.xml_str2json(d).sbml,b.saveSbml(d,function(b,c){b?(a.loadingScreen.status="danger",a.loadingScreen.body="Sorry, SBML is invalid."):c&&(a.loadingScreen.status="success",a.loadingScreen.body="Done!"),a.$apply()}))})},a.addVersion=function(){a.models.push({name:a.commitMessage,text:a.editorText,checked:!1})},a.loadFromText=function(a){b.loadModel(a)},a.loadFromUrl=function(a){f.jsonp(a+"?callback=jsonpCallback")},a.dropzoneConfig={init:function(){this.on("addedfile",function(b){var c=new FileReader;c.onload=function(){a.loadFromText(c.result)},c.readAsText(b)})},url:"/",autoProcessQueue:!1,error:function(a,b,c){console.log("Error! ",c)}},a.cancel=function(){e.close()},a.ok=function(){e.close()}}]),angular.module("sysbIoApp").controller("ExportModalCtrl",["$scope","App","Beautify",function(a,b,c){a.data=b.data;var d=function(a){var b=new Blob([a],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(b)};a.sbmlString=c.xml(b.getSbml()),a.sbmlUrl=d(a.sbmlString),a.jsonString=angular.toJson(b.data.json,4),a.jsonUrl=d(a.jsonString),b.rpc("getMatlab",{});var e=_.map(b.data.model.species,function(a){return a.id});e.unshift("time");var f=angular.copy(b.data.model.sim.raw);f.unshift(e),a.csvData=d3.csv.format(f),a.csvUrl=d(a.csvData),a.$watch("data.model.matlab",function(b){a.matlabUrl=d(b)})}]),angular.module("sysbIoApp").controller("SaveModalCtrl",["$scope","App","Beautify",function(a,b,c){a.App=b,a.github=b.data.github,a.saveToGithub=function(){var d=b.github.getRepo(a.github.user,a.github.repo);a.sbmlString=c.xml(b.x2js.json2xml_str(b.data.json)),d.write("master",a.github.file,a.sbmlString,"Saved from sysb.io",function(a){console.log("Github.js error: ",a)})}}]),angular.module("sysbIoApp").controller("SpeciesModalCtrl",["$scope","$modalInstance","App","id","model","jsonXml",function(a,b,c,d,e,f){a.id=d,a.model=e,a.lookupSpecies={},angular.forEach(a.model.listOfSpecies.species,function(b){a.lookupSpecies[b._id]=b}),a.sbmlNode=a.lookupSpecies[d],a.lookupNode={},angular.forEach(a.model.annotation.listOfCyStyles.cyStyle,function(b){a.lookupNode[b.id.__text]=b}),a.layoutNode=a.lookupNode[d],a.style={},a.style.obj=a.lookupNode[d].css,a.style.css=angular.toJson(f.unNamespaceObject(a.style.obj),4);var g=function(b){return a.style.obj[b].__text},h=function(b){return function(c){a.style.obj[b].__text=c.toHexString()}};a.extend=function(a,b){var c=angular.copy(a);return angular.extend(c,b)},a.colorOptions=["color","text-outline-color","background-color","border-color","line-color"],a.genColorOptions=function(a){return{color:g(a),change:h(a)}},a.spec={background:{color:g("background-color"),change:h("background-color")}},a.spectrumConfig={color:a.style.obj["background-color"].__text,showInput:!0,className:"full-spectrum",showInitial:!0,showPalette:!0,showSelectionPalette:!0,maxPaletteSize:10,preferredFormat:"hex",change:function(b){a.style.obj["background-color"].__text=b.toHexString()},palette:[["rgb(0, 0, 0)","rgb(67, 67, 67)","rgb(102, 102, 102)","rgb(204, 204, 204)","rgb(217, 217, 217)","rgb(255, 255, 255)"],["rgb(152, 0, 0)","rgb(255, 0, 0)","rgb(255, 153, 0)","rgb(255, 255, 0)","rgb(0, 255, 0)","rgb(0, 255, 255)","rgb(74, 134, 232)","rgb(0, 0, 255)","rgb(153, 0, 255)","rgb(255, 0, 255)"],["rgb(230, 184, 175)","rgb(244, 204, 204)","rgb(252, 229, 205)","rgb(255, 242, 204)","rgb(217, 234, 211)","rgb(208, 224, 227)","rgb(201, 218, 248)","rgb(207, 226, 243)","rgb(217, 210, 233)","rgb(234, 209, 220)","rgb(221, 126, 107)","rgb(234, 153, 153)","rgb(249, 203, 156)","rgb(255, 229, 153)","rgb(182, 215, 168)","rgb(162, 196, 201)","rgb(164, 194, 244)","rgb(159, 197, 232)","rgb(180, 167, 214)","rgb(213, 166, 189)","rgb(204, 65, 37)","rgb(224, 102, 102)","rgb(246, 178, 107)","rgb(255, 217, 102)","rgb(147, 196, 125)","rgb(118, 165, 175)","rgb(109, 158, 235)","rgb(111, 168, 220)","rgb(142, 124, 195)","rgb(194, 123, 160)","rgb(166, 28, 0)","rgb(204, 0, 0)","rgb(230, 145, 56)","rgb(241, 194, 50)","rgb(106, 168, 79)","rgb(69, 129, 142)","rgb(60, 120, 216)","rgb(61, 133, 198)","rgb(103, 78, 167)","rgb(166, 77, 121)","rgb(91, 15, 0)","rgb(102, 0, 0)","rgb(120, 63, 4)","rgb(127, 96, 0)","rgb(39, 78, 19)","rgb(12, 52, 61)","rgb(28, 69, 135)","rgb(7, 55, 99)","rgb(32, 18, 77)","rgb(76, 17, 48)"]]},a.sizeOptions=[{name:"width",min:0,max:200},{name:"height",min:0,max:200},{name:"font-size",min:0,max:30},{name:"border-width",min:0,max:20},{name:"text-outline-width",min:0,max:20}],a.parseInt=function(a){return parseInt(a,10)},a.fontOptions=[{name:"font-family",options:["Helvetica","Times New Roman","Georgia","serif","sans-serif"]},{name:"font-style",options:["normal","italic","oblique"]},{name:"font-weight",options:["normal","bold","bolder","lighter"]}],a.applyStyle=function(){var b=angular.fromJson(a.style.css);f.namespaceObject(b),a.layoutNode.css=b}}]),angular.module("sysbIoApp").controller("ReactionModalCtrl",["$scope","$modalInstance","App","id","model",function(a,b,c,d,e){a.id=d,a.model=e;var f={};a.model.listOfReactions.reaction.forEach(function(a){f[a._id]=a}),a.reaction=f[d],a.rInfo={},a.rInfo.id=a.reaction._id,a.rInfo.name=a.reaction._name,angular.forEach(c.data.model.reactions,function(b){b.id===d&&(a.rInfo.kineticLaw=b.kineticLaw)}),a.rInfo.species=[],a.model.listOfSpecies.species.forEach(function(b,c){var d=b._id;a.rInfo.species.push({id:d}),a.reaction.listOfReactants?a.reaction.listOfReactants.speciesReference.length?(a.rInfo.species[c].reactant=!1,angular.forEach(a.reaction.listOfReactants.speciesReference,function(b){b._species===d&&(a.rInfo.species[c].reactant=!0)})):(a.rInfo.species[c].reactant=!1,a.reaction.listOfReactants.speciesReference._species===d&&(a.rInfo.species[c].reactant=!0)):a.rInfo.species[c].reactant=!1,a.reaction.listOfProducts?a.reaction.listOfProducts.speciesReference.length?(a.rInfo.species[c].product=!1,angular.forEach(a.reaction.listOfProducts.speciesReference,function(b){b._species===d&&(a.rInfo.species[c].product=!0)})):(a.rInfo.species[c].product=!1,a.reaction.listOfProducts.speciesReference._species===d&&(a.rInfo.species[c].product=!0)):a.rInfo.species[c].product=!1}),a.save=function(){b.close(a.rInfo)}}]),angular.module("sysbIoApp").controller("VersionCtrl",["$scope","SbmlModel","$http","SbmlDiff","$window","Github","$routeParams",function(a,b,c,d,e,f,g){var h=function(){a.models=b.getRepo(),a.bivesUrl="https://node-bives-c9-stanley-gu.c9.io",a.previewGraphml=b.getCurrentGraphml();var c=new XMLSerializer;a.previewSbml=c.serializeToString(b.getCurrentModel().sbml),a.loadVersion=function(d){b.setCurrentIndex(d),a.previewSbml=c.serializeToString(b.getCurrentModel().sbml)},a.compareVersions=function(){var b=[],c=0;return a.models.forEach(function(a,d){a.checked&&(c+=1,b.push(d))}),c>2?(e.alert("Please check only 2 versions to compare."),void 0):(2===c&&d.getDiff(a.models[b[0]].text,a.models[b[1]].text,"compareVersions",function(b){a.modelDiff=b.diff,a.graphml=b.graphml,a.$apply()}),void 0)}};g.githubUserName?f.getVersionHistory(g.githubUserName,g.githubRepository,g.githubModelName,function(c){b.setRepo(c),a.models=b.getRepo(),h()}):h()}]),angular.module("sysbIoApp").controller("SimulateCtrl",["$scope","$window","App",function(a,b,c){a.App=c,a.sim=c.data.model.sim,a.xLabel="Time",a.chartConfig={options:{chart:{type:"line",zoomType:"x"},plotOptions:{series:{marker:{enabled:!1},events:{legendItemClick:function(b){var c=_.find(a.chartConfig.series,function(a){return a.name===b.target.name});a.seriesVisible[c.index]=!a.seriesVisible[c.index]}}}},credits:{enabled:!1}},series:[{data:[]}],title:{text:"Simulation Results"},loading:!1,xAxis:{currentMin:0,currentMax:20,title:{text:a.xLabel}},useHighStocks:!1,navigator:{adaptToUpdatedData:!1}},a.$watch("App.data.model.sim.result",function(){a.chartConfig.series=c.data.model.sim.result,a.seriesVisible?angular.forEach(a.seriesVisible,function(b,c){b||(a.chartConfig.series[c].visible=!1)}):(a.seriesVisible=[],angular.forEach(a.chartConfig.series,function(){a.seriesVisible.push(!0)}))},!0),a.checkVisible=function(){a.seriesVisible=[],angular.forEach(a.chartConfig.series,function(b){b.visible?a.seriesVisible.push(!0):a.seriesVisible.push(!1)})},a.toggleSeriesVisibility=function(){_.each(a.seriesVisible,function(a,b,c){c[b]=!c[b]}),c.simulate()},a.$watch("sim.time.start + sim.time.end + sim.time.steps",function(){a.chartConfig.xAxis.currentMin=a.sim.time.start,a.chartConfig.xAxis.currentMax=a.sim.time.end,a.chartConfig.xAxis.title={text:a.xLabel},c.simulate()}),a.$watch("App.data.json.sbml.model.listOfParameters.parameter",function(a){a&&angular.forEach(c.data.json.sbml.model.listOfParameters.parameter,function(a){a._value&&"string"==typeof a._value&&(a._value=parseFloat(a._value,10))})});var d=function(a){c.rpc("setParameterValueById",{id:c.data.model.parameters[a].id,value:c.data.model.parameters[a].value})},e=_.throttle(d,1e3,{leading:!1});a.paramUpdate=function(a){e(a)},a.App.data.slider=[],a.App.data.slider.parameters=[],a.$watch("xLabel",function(){a.chartConfig.xAxis.title={text:a.xLabel}}),a.$watch("App.data.model.parameters",function(b){b&&angular.forEach(c.data.model.parameters,function(b){a.App.data.slider.parameters.push({min:b.value-b.value,max:2*b.value,step:b.value/10})})})}]),angular.module("sysbIoApp").controller("ModelLayoutCtrl",["$scope","$modal","$timeout","App","layoutStyles","jsonXml",function(a,b,c,d,e,f){a.App=d,a.cytConfig={};var g=function(a){var b=new Blob([a],{type:"text/plain"});return(window.URL||window.webkitURL).createObjectURL(b)};a.svgToUrl=function(){var b=d.d3.svg.find("svg")[0],c=new XMLSerializer;a.svgUrl=g(c.serializeToString(b))},a.layoutStyles=e,a.defaultStyles=[{selector:"node.species",css:{shape:"roundrectangle",width:"60",height:"30",content:"data(name)","font-size":10,"text-valign":"center","text-outline-width":2,"text-outline-color":"black","border-color":"black","border-width":1,"background-color":"purple",color:"white"}},{selector:"node.reaction",css:{shape:"circle",width:"5",height:"5",content:"","font-size":5,"text-valign":"center","text-outline-width":2,"text-outline-color":"black","border-color":"black","border-width":2,"background-color":"black",color:"white"}},{selector:"edge.reaction",css:{width:2,"target-arrow-shape":"triangle","line-color":"black","line-style":"solid","source-arrow-color":"black","target-arrow-color":"black"}},{selector:"edge.modifier",css:{width:2,"target-arrow-shape":"circle","line-color":"black","line-style":"dashed","source-arrow-color":"black","target-arrow-color":"black"}},{selector:":selected",css:{"border-color":"red","line-color":"red"}}],a.updateNodeStyle=function(a,b,c){try{a.css(b,c)}catch(d){console.log("error",d)}},a.updateStyles=function(){a.cytConfig.style=[{selector:"node.species",css:a.speciesNodeStyle},{selector:"node.reaction",css:a.reactionNodeStyle},{selector:"edge",css:a.edgeStyle},{selector:":selected",css:{"border-color":"red","line-color":"red"}}]},a.cyAutoLayout={charge:-400,linkDistance:40,animate:!0},d.cy={},d.cy.settings={},d.cy.settings.autoLayout=a.cyAutoLayout,d.cy.settings.zoomingEnabled=!1,a.cyZoom=!1,a.cytConfig.ready=function(c){d.cy.cy=c,c.minZoom(.5),c.maxZoom(5),a.$watch("App.cy.settings.zoomingEnabled",function(){c.zoomingEnabled(d.cy.settings.zoomingEnabled)}),c.on("drag",function(b){var c=angular.copy(b.cyTarget.position());angular.forEach(a.App.data.json.sbml.model.annotation.listOfCyStyles.cyStyle,function(a){a.id.__text===b.cyTarget.id()&&(f.namespaceObject(c),a.position=c)})}).on("tap",function(c){if(c.cyTarget.isNode&&c.cyTarget.isNode()){var e,f=c.cyTarget;f.hasClass("species")?e=b.open({templateUrl:"views/speciesModal.html",controller:"SpeciesModalCtrl",resolve:{id:function(){return f.id()},model:function(){return a.App.data.json.sbml.model}}}):f.hasClass("reaction")&&(e=b.open({templateUrl:"views/reactionModal.html",controller:"ReactionModalCtrl",resolve:{id:function(){return f.id()},model:function(){return a.App.data.json.sbml.model}}}),e.result.then(function(a){d.rpc("updateReaction",{id:f.id(),changes:a})}))}})}}]),angular.module("sysbIoApp").controller("NodeStyleCtrl",["$scope","App","layoutStyles","jsonXml",function(a,b,c,d){a.applyStyle=function(){b.cy.cy.elements(a.cySelector).css(angular.fromJson(a.newStyles));var e=[],f=b.data.json.sbml.model.annotation||{};f.listOfCyStyles={},f.listOfCyStyles["_xmlns:sysbioModeler"]="http://sysb.io",f.listOfCyStyles.cyStyle=e,angular.forEach(b.cy.cy.elements(),function(a){var b={};b.id=a.id();var d=a.css();b.css={},$.each(c,function(a){b.css[a]=d[a]}),b.position=angular.copy(a.position()),e.push(b)}),d.namespaceObject(f.listOfCyStyles)}}]),angular.module("sysbIoApp").controller("EditModelCtrl",["$scope","App",function(a,b){a.button={getText:function(a){var b={normal:{"true":"Normal selection","false":"Click to resume normal selection"},addSpecies:{"true":"Click on the graph!","false":"Add Species"},addReaction:{"true":"Click on the graph!","false":"Add Reaction"}};return b[a][a===this.selected]},getClass:function(a){var b={normal:{"true":"btn-primary","false":"btn-danger"},addSpecies:{"true":"btn-warning","false":"btn-primary"},addReaction:{"true":"btn-warning","false":"btn-primary"}};return b[a][a===this.selected]},selected:"normal"},b.data.settings.button=a.button;var c=function(a){b.rpc("addSpecies",{id:a.id,name:a.name,compartment:a.compartment,initialAmount:a.initialAmount})};a.addSpeciesDefault=function(a){var c="node"+b.data.json.sbml.model.listOfSpecies.species.length;if(0===b.data.json.sbml.model.listOfCompartments.compartment.length)b.addCompartment({id:"compartment0",name:"compartment0",size:1,constant:!0}),b.addSpecies({id:c,name:c,compartment:"compartment0",initialAmount:0},a);else{var d=b.data.json.sbml.model.listOfCompartments.compartment;b.addSpecies({id:c,name:c,compartment:d._id||d[0]._id},a)}},a.addReactionDefault=function(a){var c="reaction"+b.data.json.sbml.model.listOfReactions.reaction.length;b.addReaction({id:c,name:c},a)},a.addParameter=function(a){b.rpc("addParameter",{id:a.id,value:a.value})},a.addSpecies=function(){c({id:a.newSpeciesId,name:a.newSpeciesName,compartment:a.newSpeciesCompartment,initialAmount:a.newSpeciesInitialAmount})};var d=a.$watch("App.d3.svg",function(c){c&&(b.d3.svg.on("mousedown",function(c){console.log(c);var d=a.button.selected;"addSpecies"===d?a.addSpeciesDefault({x:c.offsetX-b.d3.translate.x,y:c.offsetY-b.d3.translate.y}):"addReaction"===d&&a.addReactionDefault({x:c.offsetX-b.d3.translate.x,y:c.offsetY-b.d3.translate.y}),a.$apply()}),d())}),e=!1;a.$watch("App.cy.cy",function(c){e||c&&(e=!0,b.cy.cy.on("tap",function(){var b=a.button.selected;"addSpecies"===b?a.addSpeciesDefault():"addReaction"===b&&a.addReactionDefault(),a.$apply()}))})}]),angular.module("sysbIoApp").service("GithubLogin",["$window",function(a){this.getAccessToken=function(){return a.localStorage.getItem("accessToken")?a.localStorage.getItem("accessToken"):null},this.setAccessToken=function(b){a.localStorage.setItem("accessToken",b)},this.removeAccessToken=function(){a.localStorage.removeItem("accessToken")}}]),angular.module("sysbIoApp").service("SbmlModel",["$window","Sbml",function(a,b){var c=new XMLSerializer;this.getModelName=function(){this.repo=this.getRepo(),this.model=this.getCurrentModel(),this.text=this.repo[this.getCurrentIndex()].text},this.getModelSbml=function(){var a=this.getCurrentModel();if(a)return c.serializeToString(a.sbml);throw"SBML Model Not Loaded"},this.setRepo=function(b){b.forEach(function(a){a.model&&delete a.model}),a.localStorage.setItem("sbmlRepo",JSON.stringify(b))},this.getRepo=function(){if(this.repo)return this.repo;if(this.repo=JSON.parse(a.localStorage.getItem("sbmlRepo")),this.repo)return this.repo.forEach(function(a){a.model=b.loadSbml(a.text)}),this.repo;throw"No repo in localStorage"},this.updateModel=function(a){if(this.repo){var c=this.getCurrentIndex();this.repo[c].text=a,this.repo[c].model=b.loadSbml(a)}},this.saveModel=function(){this.setRepo(this.repo)},this.setCurrentIndex=function(b){a.localStorage.setItem("repoIndex",b)},this.getCurrentIndex=function(){return a.localStorage.getItem("repoIndex")},this.getCurrentModel=function(){var a;if(this.repo&&this.getCurrentIndex())return a=this.getCurrentIndex(),a=0,this.repo[a].model;if(this.repo=this.getRepo(),a=this.getCurrentIndex()||this.repo.length-1,a=0,this.repo)return this.model=this.repo[a].model,this.repo[a].model;throw"Repo not loaded"},this.setTwoDiffIndices=function(b){2===b.length&&a.localStorage.setItem("sbmlDiffIndices",JSON.stringify(b))},this.getTwoDiffIndices=function(){return JSON.parse(a.localStorage.getItem("sbmlDiffIndices"))},this.setCurrentGraphml=function(b){a.localStorage.setItem("sbmlGraphml",b)},this.getCurrentGraphml=function(){return a.localStorage.getItem("sbmlGraphml")}}]),angular.module("sysbIoApp").service("SbmlDiff",["$http","$window",function(a,b){this.bivesUrl="http://sysb.io:8002",this.getDiff=function(a,c,d,e){var f=b.io.connect(this.bivesUrl);f.emit("getDiff",{first:a,second:c,responseId:d}),f.on(d,function(a){e(a)})}}]),angular.module("sysbIoApp").service("Simulator",["$window",function(a){this.socket=a.io.connect("http://sysb.io:8003"),this.socket.on("connect",function(){console.log("connected to simulator")})}]),angular.module("sysbIoApp").service("Github",["$http",function(a){function b(a){this.name="GithubError",this.message=a}var c;this.setAccessToken=function(a){c=a},this.getFile=function(b,d,e,f){a.defaults.headers.common.Accept=a.defaults.headers.common.Accept+", application/vnd.github.VERSION.raw";var g="https://api.github.com/repos/"+b+"/"+d+"/contents/"+e;c&&(g+="?access_token="+c),a.get(g).then(function(a){f(a.data)})},this.getUserRepos=function(b,d){var e="https://api.github.com/users/"+b+"/repos";c&&(e+="?access_token="+c+"&per_page=100"),a.get(e).then(function(a){var b=[];a.data.forEach(function(a){b.push(a.name)}),d(b)})},this.getRepoFiles=function(b,d,e){var f="https://api.github.com/repos/"+b+"/"+d+"/branches/master";c&&(f+="?access_token="+c),a.get(f).then(function(f){var g="https://api.github.com/repos/"+b+"/"+d+"/git/trees/"+f.data.commit.sha+"?recursive=1";c&&(g+="&access_token="+c),a.get(g).then(function(a){var b=[];a.data.tree.forEach(function(a){b.push(a.path)}),e(b)})})},this.getVersionHistory=function(b,d,e,f){a.defaults.headers.common.Accept=a.defaults.headers.common.Accept+", application/vnd.github.VERSION.raw";var g="https://api.github.com/repos/"+b+"/"+d+"/commits?path="+e;c&&(g+="&access_token="+c),a.get(g).then(function(g){g.data.forEach(function(a){console.log(a.commit.message)});var h=g.data,i=[],j=h.length,k=0;h.forEach(function(g,h,l){var m="https://api.github.com/repos/"+b+"/"+d+"/contents/"+e;c&&(m+="?access_token="+c),a.get(m,{params:{ref:g.sha}}).then(function(a){console.log(h),console.log(g.commit.message),k+=1,i[l.length-1-h]={name:g.commit.message,text:a.data,checked:!1},k===j&&f(i)})})})},this.createRepository=function(d,e,f){var g="https://api.github.com/user/repos";if(!c)throw new b("Need an access token to create a repo.");g+="?access_token="+c,a.post(g,{name:e,description:f}).then(function(a){console.log(a)})},this.createFile=function(d,e,f){var g="https://api.github.com/repos/"+d+"/"+e+"/contents/"+f;if(!c)throw new b("Need an access token to create a file.");g+="?access_token="+c,a.put(g,{message:"first commit",content:btoa("hello world")}).then(function(a){console.log(a)})}}]),angular.module("sysbIoApp").service("Rpc",["$window",function(a){this.socket=a.io.connect("http://service.sysb.io:8080"),this.socket.on("connect",function(){console.log("connected to RPC server")})}]),angular.module("sysbIoApp").factory("App",["Rpc","GithubLogin","Github","Defaults","Constants","Beautify","$window","$rootScope",function(a,b,c,d,e,f,g,h){var i="sysbio",j=new X2JS({stripWhitespaces:!1}),k={data:{},x2js:j,save:function(){g.localStorage[i]=angular.toJson(k.data)},unsave:function(){delete g.localStorage[i]},restore:function(){return k.data=angular.fromJson(g.localStorage[i])||d,angular.forEach(d,function(a,b){k.data[b]||(k.data[b]=a)}),k.getGithub(),k.data},getGithub:function(){k.data.github.accessToken&&(k.github=new g.Github({token:k.data.github.accessToken}),k.github.getUser(void 0,function(a,b){a||(k.github.user=b)}))},loginToGithub:function(){k.getGithub(),k.save()},setAccessToken:function(a){k.data.github.accessToken=a,k.loginToGithub()},removeAccessToken:function(){k.data.github.accessToken=null},saveSbml:function(a,b){k.loadSbml(a,function(c,d){c||(k.data.model.sbml=a,h.$apply()),b(c,d)})},loadSbml:function(b,c){k.rpc("loadModel",{sbml:b});var d=function(b){b.id===a.socket.socket.sessionid&&"loadModel"===b.method&&(c(b.error,b.response),a.socket.removeListener("output",d))};a.socket.on("output",d)},generateIdLookup:function(a){var b={};return angular.forEach(a,function(a){b[a.id]=a}),b},getSbml:function(){var a=k.x2js.json2xml_str(angular.fromJson(angular.toJson(k.data.json)));return a},selectReaction:function(a){k.data.selected.reaction=angular.copy(k.getReaction(a)),angular.extend(k.data.selected.reaction,{info:{species:k.getReactionSpecies(a)}})},selectSpecies:function(a){k.data.selected.species=angular.copy(k.getSpecies(a))},getReactionSpecies:function(a){var b=k.getSpeciesIds(),c=[],d=k.getReaction(a);return angular.forEach(b,function(a){c.push({id:a,reactant:_.contains(d.reactants,a),product:_.contains(d.products,a)})}),c},getReaction:function(a){var b;return angular.forEach(k.data.model.reactions,function(c){c.id===a&&(b=c)}),b},getSpecies:function(a){var b,c=k.arrayify(k.data.json.sbml.model.listOfSpecies.species);return angular.forEach(c,function(c){c._id===a&&(b=c)}),b},getSpeciesIds:function(){var a=k.arrayify(k.data.json.sbml.model.listOfSpecies.species),b=[];return angular.forEach(a,function(a){b.push(a._id)}),b},arrayify:function(a){return"object"==typeof a?a.length?a:[a]:"string"==typeof a?a.split():void 0},jsonToD3Node:function(a,b){return angular.extend({id:a._id,name:a._name},b)},addAttributes:function(a,b){return angular.forEach(b,function(b,c){a["_"+c]=b}),a},addCompartment:function(a){var b={};k.addAttributes(b,a),k.data.json.sbml.model.listOfCompartments.compartment.push(b)},addSpecies:function(a,b){var c={};k.addAttributes(c,a),k.data.json.sbml.model.listOfSpecies.species.push(c);var d=angular.extend(k.jsonToD3Node(c,{classes:["species"]}),b);k.d3.species.push(d),k.d3.nodes.push(d)},addReaction:function(a,b){var c={};k.addAttributes(c,a),k.data.json.sbml.model.listOfReactions.reaction.push(c);var d=angular.extend(k.jsonToD3Node(c,{classes:["reaction"]}),b);k.d3.reactions.push(d),k.d3.nodes.push(d)},newModel:function(a){k.data.json=angular.copy(e.newModel),k.addAttributes(k.data.json.sbml.model,a),k.sendModel()},sendModel:function(){k.rpc("loadModel",{sbml:k.getSbml()})},rpc:function(b,c){a.socket.emit("run",{method:b,params:c})},rpcUpdate:function(){k.rpc("getCompartments",{}),k.rpc("getParameters",{}),k.rpc("getReactions",{}),k.rpc("getSpecies",{})},simulate:function(){k.data.json.sbml&&k.rpc("simulate",{timeStart:k.data.model.sim.time.start,timeEnd:k.data.model.sim.time.end,numPoints:k.data.model.sim.time.steps})},loadModel:function(a){k.data.json.sbml=k.x2js.xml_str2json(a).sbml,k.data.model.sbml=a,k.sendModel()}};return a.socket.on("output",function(b){if(b.id===a.socket.socket.sessionid){if(b.error)console.log("RPC Error calling "+b.method+": ",b.error);else if("getModel"===b.method)k.data.model.sbml=b.response,k.data.json.sbml=j.xml_str2json(b.response).sbml,k.simulate();else if("loadModel"===b.method)k.rpcUpdate(),k.simulate(),k.d3.runForceLayout();else if("createModel"===b.method)k.rpc("getModel",{});else if("addSpecies"===b.method)k.rpc("getSpecies",{}),k.rpc("getModel",{});else if("updateSpecies"===b.method)k.rpc("getSpecies",{}),k.rpc("getModel",{});else if("addCompartment"===b.method)k.rpc("getCompartments",{}),k.rpc("getModel",{});else if("addReaction"===b.method)k.rpc("getReactions",{}),k.rpc("getModel",{});else if("addParameter"===b.method)k.rpc("getModel",{}),k.rpc("getParameters",{});else if("setParameterValueById"===b.method)k.simulate(),k.rpc("getParameters",{});else if("updateReaction"===b.method)k.rpc("getReactions",{}),k.rpc("getModel",{});else if("getMatlab"===b.method)k.data.model.matlab=b.response;else if("getCompartments"===b.method)k.data.model.compartments=b.response;else if("getSpecies"===b.method)k.data.model.species=b.response;else if("getReactions"===b.method)k.data.model.reactions=b.response;else if("getModelName"===b.method)k.data.model.name=b.response;else if("getModelId"===b.method)k.data.model.id=b.response;else if("simulate"===b.method){var c,d,e,f,i,l=b.response;for(k.data.model.sim.raw=l,f=l[0].length-1,i=[],c=0;f>c;c+=1){for(e={},e.name=k.data.model.species[c].id,e.data=[],d=0;d<l.length;d+=1)e.data.push({x:l[d][0],y:l[d][c+1]});e.index=c,e.color=g.Highcharts.getOptions().colors[c%10],i.push(e)}k.data.model.sim.result=i}else if(b.method.indexOf("getParameters")>-1){var m=b.response.values,n=b.response.ids,o=[];n.length?n.forEach(function(a,b){o.push({id:a,value:m[b]})}):o.push({id:n,value:m}),k.data.model.parameters=o}h.$apply()}}),k.restore(),k}]),angular.module("sysbIoApp").factory("Sbml",["App",function(a){var b=a.data,c=new X2JS,d=c.parseXmlString(b.model.sbml),e=function(a){for(var b={},c=a.attributes,d=0;d<c.length;d++){var e=c[d];b[e.nodeName]=e.nodeValue}return b};return{loadSbmlString:function(a){return d=c.parseXmlString(a)},addAttributesToArray:function(a,b,c,d){Array.prototype.forEach.call(a,function(a){var f=e(a);if(c){var g=Object.keys(c);g.forEach(function(a){f[a]=c[a]})}d?b.push(d(f,a)):b.push(f)})},addReactionsToArray:function(a,b,c,e){var f=d.querySelectorAll("reaction");Array.prototype.forEach.call(f,function(d){var f=d.querySelector("listOfProducts");if(f){var g=f.querySelectorAll("speciesReference");Array.prototype.forEach.call(g,function(c){a.push(b(c,d))})}var h=d.querySelector("listOfReactants");if(h){var i=h.querySelectorAll("speciesReference");Array.prototype.forEach.call(i,function(b){a.push(c(b,d))})}var j=d.querySelector("listOfModifiers");if(j){var k=j.querySelectorAll("modifierSpeciesReference");Array.prototype.forEach.call(k,function(b){a.push(e(b,d))})}})},getString:function(){var a=new XMLSerializer;return a.serializeToString(d)},addLayoutFromJson:function(a){var b={layout:a},e=c.json2xml(b),f=d.querySelector("sbml model"),g=d.querySelector("sbml model annotation");g||(g=d.createElement("annotation"),f.appendChild(g));var h=g.querySelector("layout");h&&h.parentNode.removeChild(h),g.appendChild(e)},getLayoutAsJson:function(){var a=d.querySelector("sbml model annotation layout");return a?c.xml2json(a):null},getSbmlDoc:function(){return d}}}]),angular.module("sysbIoApp").value("Defaults",{model:{sim:{time:{start:0,end:100,steps:100}}},selected:{},json:{},github:{},settings:{view:{windowPane:{"90-10":{left:"col-md-11",right:"col-md-1"},"75-25":{left:"col-md-9",right:"col-md-3"},"50-50":{left:"col-md-6",right:"col-md-6"},"25-75":{left:"col-md-3",right:"col-md-9"},"10-90":{left:"col-md-1",right:"col-md-11"}},toolbar:{nodeStyles:{visible:!1},editModel:{visible:!1},simulate:{visible:!0}}}}}).value("Constants",{newModel:{sbml:{model:{listOfSpecies:{species:[]},listOfReactions:{reaction:[]},listOfCompartments:{compartment:[]}},_xmlns:"http://www.sbml.org/sbml/level2/version4",_level:"2",_version:"4"}}}),angular.module("sysbIoApp").factory("Beautify",function(){function a(a){var b="    ";
if(isNaN(parseInt(a)))b=a;else switch(a){case 1:b=" ";break;case 2:b="  ";break;case 3:b="   ";break;case 4:b="    ";break;case 5:b="     ";break;case 6:b="      ";break;case 7:b="       ";break;case 8:b="        ";break;case 9:b="         ";break;case 10:b="          ";break;case 11:b="           ";break;case 12:b="            "}for(var c=["\n"],d=0;100>d;d++)c.push(c[d]+b);return c}function b(){this.step="    ",this.shift=a(this.step)}function c(a,b){return b-(a.replace(/\(/g,"").length-a.replace(/\)/g,"").length)}function d(a,b){return a.replace(/\s{1,}/g," ").replace(/ AND /gi,"~::~"+b+b+"AND ").replace(/ BETWEEN /gi,"~::~"+b+"BETWEEN ").replace(/ CASE /gi,"~::~"+b+"CASE ").replace(/ ELSE /gi,"~::~"+b+"ELSE ").replace(/ END /gi,"~::~"+b+"END ").replace(/ FROM /gi,"~::~FROM ").replace(/ GROUP\s{1,}BY/gi,"~::~GROUP BY ").replace(/ HAVING /gi,"~::~HAVING ").replace(/ IN /gi," IN ").replace(/ JOIN /gi,"~::~JOIN ").replace(/ CROSS~::~{1,}JOIN /gi,"~::~CROSS JOIN ").replace(/ INNER~::~{1,}JOIN /gi,"~::~INNER JOIN ").replace(/ LEFT~::~{1,}JOIN /gi,"~::~LEFT JOIN ").replace(/ RIGHT~::~{1,}JOIN /gi,"~::~RIGHT JOIN ").replace(/ ON /gi,"~::~"+b+"ON ").replace(/ OR /gi,"~::~"+b+b+"OR ").replace(/ ORDER\s{1,}BY/gi,"~::~ORDER BY ").replace(/ OVER /gi,"~::~"+b+"OVER ").replace(/\(\s{0,}SELECT /gi,"~::~(SELECT ").replace(/\)\s{0,}SELECT /gi,")~::~SELECT ").replace(/ THEN /gi," THEN~::~"+b).replace(/ UNION /gi,"~::~UNION~::~").replace(/ USING /gi,"~::~USING ").replace(/ WHEN /gi,"~::~"+b+"WHEN ").replace(/ WHERE /gi,"~::~WHERE ").replace(/ WITH /gi,"~::~WITH ").replace(/ ALL /gi," ALL ").replace(/ AS /gi," AS ").replace(/ ASC /gi," ASC ").replace(/ DESC /gi," DESC ").replace(/ DISTINCT /gi," DISTINCT ").replace(/ EXISTS /gi," EXISTS ").replace(/ NOT /gi," NOT ").replace(/ NULL /gi," NULL ").replace(/ LIKE /gi," LIKE ").replace(/\s{0,}SELECT /gi,"SELECT ").replace(/\s{0,}UPDATE /gi,"UPDATE ").replace(/ SET /gi," SET ").replace(/~::~{1,}/g,"~::~").split("~::~")}return b.prototype.xml=function(b,c){var d=b.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns\:/g,"~::~xmlns:").replace(/\s*xmlns\=/g,"~::~xmlns=").split("~::~"),e=d.length,f=!1,g=0,h="",i=0,j=c?a(c):this.shift;for(i=0;e>i;i++)d[i].search(/<!/)>-1?(h+=j[g]+d[i],f=!0,(d[i].search(/-->/)>-1||d[i].search(/\]>/)>-1||d[i].search(/!DOCTYPE/)>-1)&&(f=!1)):d[i].search(/-->/)>-1||d[i].search(/\]>/)>-1?(h+=d[i],f=!1):/^<\w/.exec(d[i-1])&&/^<\/\w/.exec(d[i])&&/^<[\w:\-\.\,]+/.exec(d[i-1])==/^<\/[\w:\-\.\,]+/.exec(d[i])[0].replace("/","")?(h+=d[i],f||g--):d[i].search(/<\w/)>-1&&-1==d[i].search(/<\//)&&-1==d[i].search(/\/>/)?h=h+=f?d[i]:j[g++]+d[i]:d[i].search(/<\w/)>-1&&d[i].search(/<\//)>-1?h=h+=f?d[i]:j[g]+d[i]:d[i].search(/<\//)>-1?h=h+=f?d[i]:j[--g]+d[i]:d[i].search(/\/>/)>-1?h=h+=f?d[i]:j[g]+d[i]:h+=d[i].search(/<\?/)>-1?j[g]+d[i]:d[i].search(/xmlns\:/)>-1||d[i].search(/xmlns\=/)>-1?j[g]+d[i]:d[i];return"\n"==h[0]?h.slice(1):h},b.prototype.json=function(a,b){var b=b?b:this.step;return"undefined"==typeof JSON?a:"string"==typeof a?JSON.stringify(JSON.parse(a),null,b):"object"==typeof a?JSON.stringify(a,null,b):a},b.prototype.css=function(b,c){var d=b.replace(/\s{1,}/g," ").replace(/\{/g,"{~::~").replace(/\}/g,"~::~}~::~").replace(/\;/g,";~::~").replace(/\/\*/g,"~::~/*").replace(/\*\//g,"*/~::~").replace(/~::~\s{0,}~::~/g,"~::~").split("~::~"),e=d.length,f=0,g="",h=0,i=c?a(c):this.shift;for(h=0;e>h;h++)g+=/\{/.exec(d[h])?i[f++]+d[h]:/\}/.exec(d[h])?i[--f]+d[h]:/\*\\/.exec(d[h])?i[f]+d[h]:i[f]+d[h];return g.replace(/^\n{1,}/,"")},b.prototype.sql=function(b,e){var f=b.replace(/\s{1,}/g," ").replace(/\'/gi,"~::~'").split("~::~"),g=f.length,h=[],i=0,j=this.step,k=0,l="",m=0,n=e?a(e):this.shift;for(m=0;g>m;m++)h=m%2?h.concat(f[m]):h.concat(d(f[m],j));for(g=h.length,m=0;g>m;m++){k=c(h[m],k),/\s{0,}\s{0,}SELECT\s{0,}/.exec(h[m])&&(h[m]=h[m].replace(/\,/g,",\n"+j+j)),/\s{0,}\s{0,}SET\s{0,}/.exec(h[m])&&(h[m]=h[m].replace(/\,/g,",\n"+j+j)),/\s{0,}\(\s{0,}SELECT\s{0,}/.exec(h[m])?(i++,l+=n[i]+h[m]):/\'/.exec(h[m])?(1>k&&i&&i--,l+=h[m]):(l+=n[i]+h[m],1>k&&i&&i--)}return l=l.replace(/^\n{1,}/,"").replace(/\n{1,}/g,"\n")},b.prototype.xmlmin=function(a,b){var c=b?a:a.replace(/\<![ \r\n\t]*(--([^\-]|[\r\n]|-[^\-])*--[ \r\n\t]*)\>/g,"").replace(/[ \r\n\t]{1,}xmlns/g," xmlns");return c.replace(/>\s{0,}</g,"><")},b.prototype.jsonmin=function(a){return"undefined"==typeof JSON?a:JSON.stringify(JSON.parse(a),null,0)},b.prototype.cssmin=function(a,b){var c=b?a:a.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g,"");return c.replace(/\s{1,}/g," ").replace(/\{\s{1,}/g,"{").replace(/\}\s{1,}/g,"}").replace(/\;\s{1,}/g,";").replace(/\/\*\s{1,}/g,"/*").replace(/\*\/\s{1,}/g,"*/")},b.prototype.sqlmin=function(a){return a.replace(/\s{1,}/g," ").replace(/\s{1,}\(/,"(").replace(/\s{1,}\)/,")")},new b}),angular.module("sysbIoApp").service("jsonXml",function(){var a={namespaceObject:function(a){this.recursivelyAddProperty(a,this.prefix,this.nameSpace)},recursivelyAddProperty:function(b,c,d){"object"==typeof b&&(b[c]=d,$.each(b,function(e,f){"_"!==e[0]&&("object"!=typeof f?(b[e]={},b[e][c]=d,b[e].__text=f):a.recursivelyAddProperty(f,c,d))}))},unNamespaceObject:function(a){var b={};for(var c in a)"_"!==c[0]&&(b[c]=a[c].__text);return b},nameSpace:"sysbioModeler",prefix:"__prefix"};return a}).value("layoutStyles",{color:!0,content:!0,"font-family":!0,"font-size":!0,"font-style":!0,"font-weight":!0,"text-opacity":!0,"text-outline-color":!0,"text-outline-opacity":!0,"text-outline-width":!0,opacity:!0,visibility:!0,width:!0,"z-index":!0,"text-halign":!0,"text-valign":!0,"background-image":!0,"background-color":!0,"background-opacity":!0,"border-color":!0,"border-opacity":!0,"border-width":!0,height:!0,shape:!0,"padding-left":!0,"padding-right":!0,"padding-top":!0,"padding-bottom":!0,"line-color":!0,"line-style":!0,"source-arrow-color":!0,"source-arrow-shape":!0,"target-arrow-color":!0,"target-arrow-shape":!0}),angular.module("sysbIoApp").controller("GalleryCtrl",["$scope","$http","$window","Github","GithubLogin","SbmlDiff","SbmlModel","Sbml",function(a,b,c,d,e,f,g,h){a.bivesUrl="https://node-bives-c9-stanley-gu.c9.io",a.gallery=[],a.notes=[];var i=0;c.localStorage.getItem("galleryRepos")&&c.localStorage.getItem("galleryRepos").length>=12?a.galleryRepos=JSON.parse(c.localStorage.getItem("galleryRepos")):(a.galleryRepos=[],d.getFile("sysb-io","sysbio-gallery","list.txt",function(b){var e=b.split("\n");e.pop(),e.forEach(function(b){b=b.split(":");var e=b[0].split("/"),f=e[0],g=e[1],h=b[1];d.getFile(f,g,h,function(b){a.galleryRepos.push({user:f,repo:g,file:h,sbml:b}),0===i&&(a.loadMore(),i+=1),c.localStorage.setItem("galleryRepos",JSON.stringify(a.galleryRepos))})})})),a.loadingText="Loading more models.",a.loadMore=function(){if(i<a.galleryRepos.length){var b=a.galleryRepos[i],c=h.loadSbml(b.sbml);c.setGithubInfo(b.user,b.repo,b.file),a.gallery.push(c);var d="";try{var e=c.sbml.querySelector("body").cloneNode(!0);d=e.innerHTML}catch(f){}a.notes.push(d),i+=1}else a.loadingText=""},a.loadMore(),a.loadGalleryRepo=function(b){d.getVersionHistory(a.galleryRepos[b].user,a.galleryRepos[b].repo,a.galleryRepos[b].file,function(a){g.setRepo(a)})}}]),angular.module("sysbIoApp").directive("draggable",["$document",function(a){return{link:function(b,c){function d(a){var d=c.scope().node;d.x=a.pageX/b.scale+f.x,d.y=a.pageY/b.scale+f.y,c.scope().$apply(),b.onDrag&&b.onDrag(a,d)}function e(){a.unbind("mousemove",d),a.unbind("mouseup",e)}var f={};c.css({position:"relative",border:"1px solid red",backgroundColor:"lightgrey",cursor:"pointer"}),c.on("mousedown",function(g){g.preventDefault(),g.stopPropagation(),f.x=c.scope().node.x-g.pageX/b.scale,f.y=c.scope().node.y-g.pageY/b.scale,a.on("mousemove",d),a.on("mouseup",e)})}}}]),angular.module("sysbIoApp").directive("help",function(){return{transclude:!0,template:"<div ng-transclude></div>",restrict:"E",link:function(a,b){b.click(function(a){a.stopPropagation(),$("body").chardinJs("start")}),$(document).on("chardinJs:start",function(){$(".chardinjs-overlay").on("click",function(a){a.stopPropagation()})})}}}),angular.module("sysbIoApp").directive("cyt",["jsonXml",function(a){return{template:"<div></div>",restrict:"E",scope:{sbml:"=",ready:"=?",cy:"=?",defaultStyles:"=?",layout:"=?",saveStyles:"=",zoom:"=?"},link:function(b,c){var d=function(a,b,c){var d={data:$.extend({},a,b)};return d.group=d.data.source&&d.data.target?"edges":"nodes",$.extend(d,c),d},e=function(a){var b=((a||{}).listOfSpecies||{}).species||{}||[],c=((a||{}).listOfReactions||{}).reaction||{}||[],e=$.map(b,function(a){return d(a,{id:a._id,name:a._name},{classes:"species"})}),f=$.map(c,function(a){return d(a,{id:a._id,name:a._name},{classes:"reaction"})});return $.merge(e,f)},f=function(a){var b=[],c=((a||{}).listOfReactions||{}).reaction||{}||[];return $.each(c,function(a,c){var e=c.listOfReactants;e&&(e.speciesReference.length?$.each(e.speciesReference,function(a,f){b.push(d(e,{source:f._species,target:c._id},{classes:"reaction"}))}):b.push(d(e,{source:e.speciesReference._species,target:c._id},{classes:"reaction"})));var f=c.listOfProducts;f&&(f.speciesReference.length?$.each(f.speciesReference,function(a,f){b.push(d(e,{source:c._id,target:f._species},{classes:"reaction"}))}):b.push(d(e,{source:c._id,target:f.speciesReference._species},{classes:"reaction"})));var g=c.listOfModifiers;g&&(g.modifierSpeciesReference.length?$.each(g.modifierSpeciesReference,function(a,f){b.push(d(e,{source:f._species,target:c._id},{classes:"modifier"}))}):b.push(d(e,{source:g.modifierSpeciesReference._species,target:c._id},{classes:"modifier"})))}),b},g=function(a){var b={};for(var c in a)"_"!==c[0]&&(b[c]=a[c].__text);return b},h=function(c,d){if(c&&d){var e=((((c||{}).model||{}).annotation||{}).listOfCyStyles||{}).cyStyle;if(!e){c.model.annotation=c.model.annotation||{},c.model.annotation.listOfCyStyles=c.model.annotation.listOfCyStyles||{};var f=c.model.annotation.listOfCyStyles;f.cyStyle=f.cyStyle||[],e=f.cyStyle}var h={};d.nodes().each(function(a,b){h[b.id()]=!0});var i={};angular.forEach(e,function(a,b){i[a.id.__text]=a;var c=g(a.position),f=a.id.__text;delete h[f];var j=d.nodes("#"+f);j.isNode()?j.position({x:parseFloat(c.x,10),y:parseFloat(c.y,10)}).css(g(a.css)):e.splice(b,1)}),angular.forEach(h,function(c,f){var g=d.nodes("#"+f),h=i[f]||{};h.id=g.id();var j=g.css();h.css={},$.each(b.saveStyles,function(a){h.css[a]=j[a]}),h.position=angular.copy(g.position()),a.namespaceObject(h),e.push(h)})}},i=function(c){var d=function(){var c=[];b.sbml.model.annotation||(b.sbml.model.annotation={});var d=b.sbml.model.annotation;d.listOfCyStyles={},d.listOfCyStyles["_xmlns:sysbioModeler"]="http://sysb.io",d.listOfCyStyles.cyStyle=c,angular.forEach(b.cy.nodes(),function(a){var d={};d.id=a.id();var e=a.css();d.css={},$.each(b.saveStyles,function(a){d.css[a]=e[a]}),d.position=angular.copy(a.position()),c.push(d)}),a.namespaceObject(d.listOfCyStyles)},e=b.cy,f=$(e.container()),g=f.width(),h=f.height(),i={},j=$.map(e.nodes(),function(a,b){return i[a.id()]=b,{index:b,x:a.position().x,y:a.position().y}}),k=$.map(e.edges(),function(a){return{source:i[a.source().id()],target:i[a.target().id()]}}),l=d3.layout.force().nodes(j).links(k).size([g,h]).linkDistance(c.linkDistance||20).charge(c.charge||-300).start(),m=function(){$.each(l.nodes(),function(a,b){e.nodes()[a].position({x:b.x,y:b.y})})};l.on("tick",function(){c.animate&&m()}),l.on("end",function(){m(),d()})},j=function(a,c){a.model.annotation&&a.model.annotation.listOfCyStyles?h(a,c):b.layout&&i(b.layout)},k=function(a,b){var c=a.model,d=$.merge(e(c),f(c));b.load(d,void 0,function(){j(a,b)})},l=function(){c.css("height","100%"),c.css("width","100%"),c.css("left",0),c.css("top",0),c.css("position","absolute"),$(c).cytoscape({showOverlay:!1,style:b.defaultStyles,ready:function(){b.cy=this,b.cy.autoLayout=i,b.zoom||b.cy.zoomingEnabled(!1),b.cy.one("layoutstop",function(){var a=["sbml.model.listOfSpecies","sbml.model.listOfReactions","sbml.model.listOfCompartments"];angular.forEach(a,function(a){b.$watch(a,function(a){a&&k(b.sbml,b.cy)},!0)});var c=["sbml.model.annotation.listOfCyStyles.cyStyle","defaultStyles"];angular.forEach(c,function(a){b.$watch(a,function(a){a&&h(b.sbml,b.cy)},!0)}),b.ready(b.cy),b.$apply()})}})};l()}}}]),angular.module("sysbIoApp").directive("inputFix",function(){return{link:function(a,b,c){a.$watch(c.inputFix,function(a){"string"==typeof a&&(a=parseFloat(a,10)),b.val(a)}),b.bind("change",function(){a[c.fix]=b.val(),a.$digest()})}}}),angular.module("sysbIoApp").directive("sbmlLayout",["$document","$modal","App",function(a,b,c){return{templateUrl:"/views/sbmlLayout.html",restrict:"E",scope:{ngModel:"=",linkDistance:"=?",charge:"=?",height:"=",scale:"=",force:"=?",nodes:"=?",links:"=?",svg:"=?",species:"=?",reactions:"=?",translate:"=?",runForceLayout:"=?"},link:function(a,d){function e(){a.scale=d3.event.scale,a.translate.x=d3.event.translate[0],a.translate.y=d3.event.translate[1],a.$digest()}a.translate={},a.scale=1;var f=d3.behavior.zoom().translate([0,0]).scale(1).scaleExtent([.5,8]).on("zoom",e);d3.select(d.find("svg")[0]).call(f),a.arrow=d3.svg.symbol().size(function(a){return a.size}).type(function(a){return a.type}),a.$modal=b,a.svg=d,a.App=c;var g=function(a){var b,c=((a||{}).listOfSpecies||{}).species||{}||[],d=((a||{}).listOfReactions||{}).reaction||{}||[];b=c.length?$.map(c,function(a){return{id:a._id,name:a._name,classes:["species"]}}):[{id:c._id,name:c._name,classes:["species"]}];var e;return e=d.length?$.map(d,function(a){return{id:a._id,name:a._name,classes:["reaction"]}}):[{id:d._id,name:d._name,classes:["reaction"]}],$.merge(b,e)},h=function(a){var b=[],c=((a||{}).listOfReactions||{}).reaction||{}||[],d=function(a){var c=a.listOfReactants;c&&(c.speciesReference.length?$.each(c.speciesReference,function(c,d){b.push({source:d._species,target:a._id,reaction:a,classes:["reaction","consumption"]})}):b.push({source:c.speciesReference._species,target:a._id,reaction:a,classes:["reaction","consumption"]}));var d=a.listOfProducts;d&&(d.speciesReference.length?$.each(d.speciesReference,function(c,d){b.push({source:a._id,target:d._species,reaction:a,classes:["reaction","production"]})}):b.push({source:a._id,target:d.speciesReference._species,reaction:a,classes:["reaction","production"]}));var e=a.listOfModifiers;e&&(e.modifierSpeciesReference.length?$.each(e.modifierSpeciesReference,function(c,d){b.push({source:d._species,target:a._id,reaction:a,classes:["modifier"]})}):b.push({source:e.modifierSpeciesReference._species,target:a._id,reaction:a,classes:["modifier"]}))};return c.length?$.each(c,function(a,b){d(b)}):d(c),b};a.sizeLookup={species:30,reaction:5},a.lookupMarkerId=function(a){return _.every(a,function(a){return _.contains(["reaction","production"],a)})?"reactionProduction":_.every(a,function(a){return _.contains(["reaction","production"],a)})?"reactionConsumption":void 0},a.textVisibilityLookup={species:!0,reaction:!1},a.color=d3.scale.category20(),a.getReactionPosition=function(b){var d=c.generateIdLookup(c.data.model.reactions),e=c.generateIdLookup(a.nodes),f=_.union(d[b].products,d[b].reactants);if(f.length<=1)return e[b];var g=0,h=0;return angular.forEach(f,function(a){g+=e[a].x,h+=e[a].y}),{x:g/f.length,y:h/f.length}},a.extendPoint=function(a,b,c){var d=Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2));return{x:b.x+(b.x-a.x)/d*c,y:b.y+(b.y-a.y)/d*c}},a.runForceLayout=function(){if(a.ngModel.sbml){a.nodes=g(a.ngModel.sbml.model),a.edges=h(a.ngModel.sbml.model),a.species=_.filter(a.nodes,function(a){return _.contains(a.classes,"species")}),a.reactions=_.filter(a.nodes,function(a){return _.contains(a.classes,"reaction")});var b={};angular.forEach(a.nodes,function(a,c){b[a.id]=c}),a.links=$.map(a.edges,function(a){return{source:b[a.source],target:b[a.target],classes:a.classes}}),a.force=d3.layout.force().charge(a.charge||-120).linkDistance(a.linkDistance||30).size([d.width(),a.height]),a.force.nodes(a.nodes).links(a.links).on("tick",function(){a.$digest()}).start(),a.lines=i(a.links,a.nodes)}};var i=function(a,b){var c={production:[],reactant:[],degradation:[],modifier:[]},d={};return _.each(a,function(a){var b=function(a){d[a]=d[a]||{asSource:[],asTarget:[]}};b(a.source.id),b(a.target.id),d[a.source.id].asSource.push(a),d[a.target.id].asTarget.push(a)}),_.each(a,function(a){var e=b[a.source.index],f=b[a.target.index];_.contains(a.classes,"modifier")?c.modifier.push(a):_.contains(e.classes,"reaction")?_.contains(f.classes,"species")&&c.production.push(a):_.contains(e.classes,"species")&&_.contains(f.classes,"reaction")&&(d[f.id].asSource.length>0?c.reactant.push(a):c.degradation.push(a))}),c};a.runForceLayout()}}}]),angular.module("sysbIoApp").directive("caseSensitive",function(){return{link:function(a,b,c){a.attr=c;var d=c.caseSensitive.split(",");angular.forEach(d,function(c){var d=c.toLowerCase();a.$watch("attr[lowercase]",function(){b[0].setAttribute(c,b[0].getAttribute(d))})})}}}),angular.module("sysbIoApp").controller("NavCtrl",["$scope","$location",function(a,b){a.isCurrentRoute=function(a){return b.path()===a}}]);